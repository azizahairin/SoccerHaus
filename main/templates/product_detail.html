{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>{{ product.name }} – SoccerHaus</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<!-- Page BG -->
<div class="min-h-screen w-full bg-[var(--brand-pink)] pt-24 px-4">
  <div class="max-w-2xl mx-auto">

    <!-- Back link -->
    <a href="{% url 'main:show_main' %}"
       class="inline-flex items-center text-[#3F5A83] hover:underline font-medium mb-4">
      ← Back to Products
    </a>

    <!-- ===== Loading State (AJAX) ===== -->
    <div id="loading-state" class="bg-white rounded-2xl shadow-md border border-gray-200 p-10 text-center">
      <svg class="animate-spin h-8 w-8 text-[#3F5A83] inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <p class="text-gray-600 mt-3">Loading product detail...</p>
    </div>

    <!-- ===== Error State (AJAX) ===== -->
    <div id="error-state" class="bg-white rounded-2xl shadow-md border border-gray-200 p-10 text-center hidden">
      <div class="text-red-500 text-5xl mb-3">⚠️</div>
      <h3 class="text-lg font-semibold text-gray-900">Failed to load product</h3>
      <p class="text-gray-500">Please try again later.</p>
    </div>

    <!-- ===== Article (AJAX-filled, UI kamu) ===== -->
    <article id="article-content" class="bg-[#E8E2D4] rounded-2xl shadow-md overflow-hidden hidden">
      <!-- Top: image -->
      <div class="bg-white">
        <div class="aspect-[16/9] w-full overflow-hidden">
          <img id="detail-thumb" src="" alt="" class="w-full h-full object-cover hidden">
          <div id="detail-thumb-fallback" class="w-full h-full bg-gray-200 flex items-center justify-center">
            <img src="{% static 'image/no-products.png' %}" alt="No image"
                 class="w-40 h-40 object-contain opacity-70">
          </div>
        </div>
      </div>

      <!-- Content -->
      <div class="p-6 sm:p-8">
        <!-- Badges -->
        <div class="flex flex-wrap gap-2 mb-4" id="detail-badges">
          <span id="badge-category"
                class="px-3 py-1 rounded-full text-xs font-semibold text-white"
                style="background-color:#3F5A83;"></span>
          <span id="badge-owner"
                class="px-2.5 py-1 rounded-full text-[11px] font-semibold bg-green-100 text-green-700 border border-green-300 hidden">Owner</span>
          <span id="badge-featured"
                class="px-3 py-1 rounded-full text-xs font-semibold text-[#3F5A83] bg-white border border-[#3F5A83]/20 hidden">Featured</span>
        </div>

        <!-- Title & price -->
        <div class="flex flex-col md:flex-row md:items-baseline md:justify-between gap-2 mb-2">
          <h1 id="detail-title" class="text-3xl font-extrabold text-[#1f2937]"></h1>
          <div id="detail-price" class="text-lg font-semibold text-[#3F5A83] hidden"></div>
        </div>

        <!-- Description -->
        <div id="detail-desc" class="mt-4 text-[#374151] leading-relaxed whitespace-pre-line"></div>

        <!-- Owner box -->
        <div class="mt-8 border-t border-white/60 pt-6 bg-white/30 rounded-xl p-4">
          <p class="text-sm font-semibold text-[#1f2937]" id="detail-owner-line">Owner: </p>
          <p class="text-xs text-[#6b7280]">Product Owner</p>
        </div>

        <!-- Actions (owner only) -->
        <div id="detail-actions" class="mt-6 flex flex-wrap gap-3 hidden">
          <a id="detail-edit-link" href="#" class="px-4 py-2 rounded-md text-sm font-medium text-white" style="background-color:#E2A7B6;">Edit</a>
          <button id="detail-delete-btn" class="px-4 py-2 rounded-md text-sm font-medium text-white" style="background-color:#3F5A83;">Delete</button>
        </div>
      </div>
    </article>

  </div>
</div>

<!-- Toast -->
<div id="toast-wrap" class="fixed bottom-6 right-6 space-y-2 z-[60]"></div>
<script>
  function showToast(title, message='', type='info') {
    const wrap = document.getElementById('toast-wrap');
    const el = document.createElement('div');
    const colors = { success:'bg-green-600', error:'bg-red-600', info:'bg-gray-800', warn:'bg-yellow-600' };
    el.className = `${colors[type]||colors.info} text-white rounded-lg shadow-lg px-4 py-3 max-w-xs`;
    el.innerHTML = `<div class="font-semibold">${title}</div>${message?`<div class="text-sm opacity-90 mt-0.5">${message}</div>`:''}`;
    wrap.appendChild(el); setTimeout(()=>{ el.classList.add('opacity-0'); setTimeout(()=>el.remove(), 300); }, 2200);
  }
</script>

<!-- Confirm Delete Modal -->
<div id="confirmDeleteModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50">
  <div class="bg-white rounded-lg shadow-lg w-11/12 sm:w-[420px] overflow-hidden">
    <div class="p-5 border-b">
      <h3 class="text-lg font-semibold text-gray-900">Delete Product</h3>
      <p id="del-sub" class="text-sm text-gray-600 mt-1">Are you sure?</p>
    </div>
    <div class="p-5 flex flex-col sm:flex-row gap-3 justify-end">
      <button type="button" class="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50" onclick="hideDeleteModal()">Cancel</button>
      <button type="button" id="btn-confirm-del" class="px-4 py-2 rounded-md text-white" style="background-color:#3F5A83;">Delete</button>
    </div>
  </div>
</div>

<!-- === Inline Script (AJAX) === -->
<script>
const PRODUCT_ID = "{{ product.id }}";
const PRODUCT_DETAIL_ENDPOINT = "{% url 'main:show_json_by_id' product.id %}";
const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";

const loadingState = document.getElementById('loading-state');
const errorState   = document.getElementById('error-state');
const articleEl    = document.getElementById('article-content');

const imgEl        = document.getElementById('detail-thumb');
const imgFallback  = document.getElementById('detail-thumb-fallback');

const badgeCategory= document.getElementById('badge-category');
const badgeOwner   = document.getElementById('badge-owner');
const badgeFeatured= document.getElementById('badge-featured');

const titleEl      = document.getElementById('detail-title');
const priceEl      = document.getElementById('detail-price');
const descEl       = document.getElementById('detail-desc');

const ownerLine    = document.getElementById('detail-owner-line');
const actionsEl    = document.getElementById('detail-actions');
const editLink     = document.getElementById('detail-edit-link');
const deleteBtn    = document.getElementById('detail-delete-btn');

function showState(state) {
  loadingState.classList.toggle('hidden', state !== 'loading');
  errorState.classList.toggle('hidden', state !== 'error');
  articleEl.classList.toggle('hidden', state !== 'ready');
}
function getReadableCategoryName(code) {
  const map = { jersey:'Jersey', shoes:'Shoes', ball:'Ball', accessories:'Accessories', equipment:'Equipment' };
  return map[code] || code || 'Uncategorized';
}
function getCsrfToken(){
  const m = document.cookie.match(/csrftoken=([^;]+)/);
  return m ? decodeURIComponent(m[1]) : '';
}

function renderProduct(p) {
  titleEl.textContent = p.title || '(No name)';
  if (p.price !== null && p.price !== undefined) {
    priceEl.textContent = new Intl.NumberFormat('id-ID', { style:'currency', currency:'IDR', maximumFractionDigits:0 }).format(Number(p.price)||0);    priceEl.classList.remove('hidden');
  } else { priceEl.classList.add('hidden'); }

  if (p.thumbnail) {
    imgEl.src = p.thumbnail; imgEl.alt = p.title || ''; imgEl.classList.remove('hidden'); imgFallback.classList.add('hidden');
  } else { imgEl.classList.add('hidden'); imgFallback.classList.remove('hidden'); }

  badgeCategory.textContent = getReadableCategoryName(p.category);
  if (p.is_featured) badgeFeatured.classList.remove('hidden'); else badgeFeatured.classList.add('hidden');

  if (p.user_id && CURRENT_USER_ID && Number(p.user_id) === Number(CURRENT_USER_ID)) badgeOwner.classList.remove('hidden'); else badgeOwner.classList.add('hidden');

  descEl.textContent = p.content || '';
  ownerLine.textContent = 'Owner: ' + (p.user_username || 'Anonymous');

  if (p.user_id && CURRENT_USER_ID && Number(p.user_id) === Number(CURRENT_USER_ID)) {
    actionsEl.classList.remove('hidden');
    editLink.href = "#"; // tetap UI tombol edit, kalau mau buka modal dari main page tidak tersedia di sini
    editLink.addEventListener('click', (e)=>{ e.preventDefault(); showToast('Tip', 'Edit via main page modal.', 'info'); });
    deleteBtn.onclick = () => openDeleteModal(p.id, p.title || 'this product');
  } else {
    actionsEl.classList.add('hidden');
  }
  document.title = (p.title ? (p.title + ' – SoccerHaus') : 'SoccerHaus');
}

async function loadProduct() {
  try {
    showState('loading');
    const res = await fetch(PRODUCT_DETAIL_ENDPOINT, { headers: { 'Accept':'application/json' }});
    if (!res.ok) throw new Error('Failed to fetch product detail');
    const data = await res.json();
    renderProduct(data);
    showState('ready');
  } catch (err) {
    console.error(err);
    showState('error');
    showToast('Load Failed', 'Could not fetch product detail.', 'error');
  }
}

// Delete via AJAX (with confirm modal)
const delModal = document.getElementById('confirmDeleteModal');
let pendingDeleteId = null;
function openDeleteModal(id, title='this product'){ pendingDeleteId = id; document.getElementById('del-sub').textContent = `Delete “${title}”?`; delModal.classList.remove('hidden'); }
function hideDeleteModal(){ delModal.classList.add('hidden'); pendingDeleteId = null; }
document.getElementById('btn-confirm-del').addEventListener('click', async ()=>{
  if (!pendingDeleteId) return;
  const csrf = getCsrfToken();
  const url = `{% url 'main:delete_product_ajax' 0 %}`.replace(/0\/?$/, String(pendingDeleteId) + '/');
  const btn = document.getElementById('btn-confirm-del'); const prev = btn.textContent; btn.disabled = true; btn.textContent = 'Deleting...';
  try {
    const res = await fetch(url, { method:'POST', headers: csrf ? { 'X-CSRFToken': csrf } : {} });
    if (!res.ok) { const t = await res.text(); throw new Error(t || 'Delete failed'); }
    showToast('Deleted', 'Product removed.', 'success');
    // redirect ke main
    setTimeout(()=> window.location.href = "{% url 'main:show_main' %}", 500);
  } catch (e) {
    console.error(e); showToast('Delete Failed', String(e.message||e), 'error');
  } finally {
    btn.disabled = false; btn.textContent = prev; hideDeleteModal();
  }
});

loadProduct();
</script>
{% endblock content %}
